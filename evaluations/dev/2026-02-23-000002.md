---
agent: dev
version: 1.1.0
git_hash: abf6ad6144927385a9d32b0a50ca64c256f9bd65
task_summary: Debug HTTP 500 on Discord OAuth callback in production Vercel deployment
date: 2026-02-23T00:00:02Z
evaluator: orchestrator
rating: 2/5
loops_required: 4
---

## What Was Asked
Identify and fix the root cause of an HTTP 500 error on the `/api/auth/discord/callback` route after a successful Discord OAuth redirect.

## What Worked
- Eventually identified that the DB driver was incompatible with the Vercel serverless environment
- `tsc --noEmit` passed after the DB driver change

## What Didn't Work
- **Spawned multiple background log-watcher processes** (`vercel logs` in background mode) instead of reading the source code directly. These processes all timed out after 5 minutes with "waiting for new logs... WARN! Exceeded query duration limit". This generated noise, consumed time, and triggered repeated user interruptions.
- **Diagnosed the wrong root cause from speculation alone.** Declared that `pg.Pool` fails on Vercel because of "persistent TCP connection lifecycle management" — but this was never confirmed by actual error output. The real error (API incompatibility in `@neondatabase/serverless` v1.x) was completely different.
- **Introduced a new bug while fixing a speculative one.** Switched to `drizzle-orm/neon-http` + `neon()` from `@neondatabase/serverless`, but did not check that `drizzle-orm` 0.30 uses the old calling convention (`sql("SELECT", [args])`) incompatible with `@neondatabase/serverless` v1.x's tagged-template-only API. This caused a new, different 500 error.
- **Did not read the callback source code** before proposing a fix. The actual error was in the DB layer but only surfaced after a try/catch was added and the user re-triggered the flow.
- Required the orchestrator to directly read the source files and identify the version mismatch before a correct fix could be delegated.

## Recommendations for Agent Improvement
- **Never start background log-watcher processes for debugging.** `vercel logs` is a streaming tail — it waits for future events. For debugging a known failure, read the source code instead.
- **Read code before diagnosing.** Before proposing any infrastructure change, read the actual handler and its dependencies to understand the full call chain. Speculation without evidence produces incorrect root causes.
- **Check library version compatibility before switching drivers.** When changing a DB adapter, confirm that the new adapter's API matches what the ORM version expects. Check `package.json` versions and the ORM's changelog.
- **Prefer adding a try/catch to surface the real error** when a 500 has no visible output, rather than speculating about the cause from static analysis alone.
- **Use `printf` not `echo` when piping values to shell commands** to avoid trailing newlines.
